

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sending and Receiving Packets &mdash; Embedded Tutorials 1.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=cb963dba" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=fc837d61"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/custom.js?v=5fde6192"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ARM Math" href="arm_math.html" />
    <link rel="prev" title="Cyclic Redundancy Check (CRC)" href="crc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Embedded Tutorials
              <img src="../_static/club-logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arduino_basics_tutorial.html">Arduino Basics Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stm32_basics_tutorial.html">STM32 Basics Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../intermediate_tutorial.html">Intermediate Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cpp_setup_in_stm32.html">C++ Setup in STM32</a></li>
<li class="toctree-l2"><a class="reference internal" href="crc.html">Cyclic Redundancy Check (CRC)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Sending and Receiving Packets</a></li>
<li class="toctree-l2"><a class="reference internal" href="arm_math.html">ARM Math</a></li>
<li class="toctree-l2"><a class="reference internal" href="matrix_operation.html">Matrix Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="game_controller.html">Game Controller</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../highlights.html">Highlights</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Embedded Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../intermediate_tutorial.html">Intermediate Tutorial</a></li>
      <li class="breadcrumb-item active">Sending and Receiving Packets</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Robotics-Club-Pulchowk/EmbeddedTutorials/blob/main/source/intermediate_tutorial/sending_and_receiving_packets.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sending-and-receiving-packets">
<h1>Sending and Receiving Packets<a class="headerlink" href="#sending-and-receiving-packets" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id18">1. Introduction</a></p></li>
<li><p><a class="reference internal" href="#understanding-checksum" id="id19">2. Understanding Checksum</a></p>
<ul>
<li><p><a class="reference internal" href="#addition-based-checksum" id="id20">2.1. Addition based Checksum</a></p></li>
<li><p><a class="reference internal" href="#xor-based-checksum" id="id21">2.2. XOR based Checksum</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#need-of-crc" id="id22">3. Need of CRC</a></p></li>
<li><p><a class="reference internal" href="#implementing-smbus-crc-8" id="id23">4. Implementing SMBus CRC-8</a></p></li>
<li><p><a class="reference internal" href="#sending-packets-through-uart-using-arduino" id="id24">5. Sending Packets through UART using Arduino</a></p></li>
<li><p><a class="reference internal" href="#receiving-packets-through-uart-using-arduino" id="id25">6. Receiving Packets through UART using Arduino</a></p></li>
<li><p><a class="reference internal" href="#sending-packets-through-uart-using-stm32" id="id26">7. Sending Packets through UART using STM32</a></p></li>
<li><p><a class="reference internal" href="#receiving-packets-through-uart-using-stm32" id="id27">8. Receiving Packets through UART using STM32</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">1. Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Sending and receiving one byte of data is simple. But what if you want to send and receive multiple bytes of data? Now, you need to think of a way to structure the data so that the receiver can determine the first byte when receiving bytes continuously. Long bytes of data are prone to errors. Now, you need to think of error detection. Let’s start packetizing data.</p>
<p>A simple packet contains sunchronization bytes, data and error detection bytes. The simple synchronization method is using start bytes. Start bytes have a value which also can be present in data. The error detection bytes play important role to detect any misalignment and errors. There are techniques to calculate error detection bytes. The simple technique is checksum and a better technique is cyclic redundancy check (CRC).</p>
</section>
<section id="understanding-checksum">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">2. Understanding Checksum</a><a class="headerlink" href="#understanding-checksum" title="Link to this heading"></a></h2>
<p>It is really easy to calculate checksum of data packet. Checksum is calculated using two method.</p>
<section id="addition-based-checksum">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">2.1. Addition based Checksum</a><a class="headerlink" href="#addition-based-checksum" title="Link to this heading"></a></h3>
<p>Checksum is calculated by adding each bytes of data. The addtion can overflowe if size of checksum is small. Consider size of checksum is one byte. Let’s write test code to calculate checksum of bytes using addition.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">getAddBasedChecksum</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="linenos"> 5</span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">10</span><span class="w">   </span><span class="p">{</span>
<span class="linenos">11</span><span class="w">      </span><span class="n">checksum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">12</span><span class="w">   </span><span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">checksum</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos">18</span><span class="p">{</span>
<span class="linenos">19</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">};</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getAddBasedChecksum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="linenos">22</span><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;checksum: %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">25</span><span class="p">}</span>
</pre></div>
</div>
<p>Compile and run this test code.</p>
</section>
<section id="xor-based-checksum">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">2.2. XOR based Checksum</a><a class="headerlink" href="#xor-based-checksum" title="Link to this heading"></a></h3>
<p>Let’s talk about binary addition and XOR.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Addition</p></th>
<th class="head"><p>XOR</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0 + 0 = 0</p></td>
<td><p>0 XOR 0 = 0</p></td>
</tr>
<tr class="row-odd"><td><p>0 + 1 = 1</p></td>
<td><p>0 XOR 1 = 1</p></td>
</tr>
<tr class="row-even"><td><p>1 + 0 = 1</p></td>
<td><p>1 XOR 0 = 1</p></td>
</tr>
<tr class="row-odd"><td><p>1 + 1 = 0 (carry 1)</p></td>
<td><p>1 XOR 1 = 0</p></td>
</tr>
</tbody>
</table>
<p>Binary Addition and XOR are same for first three. But for two 1’s, Addition takes carry but XOR neglects it. Let’s write test code for XOR based checksum calculation.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">getXORBasedChecksum</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="linenos"> 5</span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">10</span><span class="w">   </span><span class="p">{</span>
<span class="linenos">11</span><span class="w">      </span><span class="n">checksum</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">12</span><span class="w">   </span><span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">checksum</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos">18</span><span class="p">{</span>
<span class="linenos">19</span><span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">};</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getXORBasedChecksum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="linenos">22</span><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;checksum: %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">25</span><span class="p">}</span>
</pre></div>
</div>
<p>Compile and run this code.</p>
</section>
</section>
<section id="need-of-crc">
<h2><a class="toc-backref" href="#id22" role="doc-backlink">3. Need of CRC</a><a class="headerlink" href="#need-of-crc" title="Link to this heading"></a></h2>
<p>Checksum is simple and fast but there is high chance of collision. Suppose two bytes having value <code class="docutils literal notranslate"><span class="pre">3</span></code> and <code class="docutils literal notranslate"><span class="pre">4</span></code>. The sum is <code class="docutils literal notranslate"><span class="pre">7</span></code>. Also suppose two bytes having vallue <code class="docutils literal notranslate"><span class="pre">5</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code>. The sum is <code class="docutils literal notranslate"><span class="pre">7</span></code> too. It is failure of checksum.</p>
<p>We have already discussed about CRC in <a class="reference external" href="crc.html">previous</a> tutorial. The CRC template class was general but it is bettr to have specific CRC class that has to be used for performance. Let’s write a simple SMBus CRC-8 class.</p>
</section>
<section id="implementing-smbus-crc-8">
<h2><a class="toc-backref" href="#id23" role="doc-backlink">4. Implementing SMBus CRC-8</a><a class="headerlink" href="#implementing-smbus-crc-8" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line"><strong>Width</strong>: 8</div>
<div class="line"><strong>Polynomial</strong>: 0x07</div>
<div class="line"><strong>Initial Value</strong>: 0x00</div>
<div class="line"><strong>Final XOR Value</strong>: 0x00</div>
<div class="line"><strong>Reflect Input</strong>: False</div>
<div class="line"><strong>Reflect Output</strong>: False</div>
</div>
<p>Let’s create header and souce file.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">crc8.hpp</span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/**</span>
<span class="linenos"> 2</span><span class="cm"> ******************************************************************************</span>
<span class="linenos"> 3</span><span class="cm"> * @file    crc8.hpp</span>
<span class="linenos"> 4</span><span class="cm"> * @brief   Header file 8-bit SMBus CRC calculation</span>
<span class="linenos"> 5</span><span class="cm"> * @author  Robotics Team, IOE Pulchowk Campus</span>
<span class="linenos"> 6</span><span class="cm"> ******************************************************************************</span>
<span class="linenos"> 7</span><span class="cm"> */</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="cp">#ifndef CRC8_HPP</span>
<span class="linenos">10</span><span class="cp">#define CRC8_HPP</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#define CRC8_SMBUS_POLYNOMIAL 0x07 </span><span class="cm">/**&lt; CRC-8 polynomial for SMBus. */</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="cm">/**</span>
<span class="linenos">17</span><span class="cm"> * @brief Class for CRC-8 checksum calculation.</span>
<span class="linenos">18</span><span class="cm"> */</span>
<span class="linenos">19</span><span class="k">class</span><span class="w"> </span><span class="nc">CRC8</span>
<span class="linenos">20</span><span class="p">{</span>
<span class="linenos">21</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">22</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos">23</span><span class="cm">     * @brief Calculate CRC-8 checksum for uint8_t type data.</span>
<span class="linenos">24</span><span class="cm">     * @param buf Pointer to the data buffer.</span>
<span class="linenos">25</span><span class="cm">     * @param len Length of the data buffer.</span>
<span class="linenos">26</span><span class="cm">     * @return CRC-8 checksum value.</span>
<span class="linenos">27</span><span class="cm">     */</span>
<span class="linenos">28</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">get_hash</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos">31</span><span class="cm">     * @brief Print the CRC hash table.</span>
<span class="linenos">32</span><span class="cm">     */</span>
<span class="linenos">33</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print_table</span><span class="p">();</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">get_polynomial</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">polynomial_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="cm">/**&lt; Get the CRC polynomial. */</span>
<span class="linenos">36</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">get_check</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">check_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">           </span><span class="cm">/**&lt; Get the CRC check value. */</span>
<span class="linenos">37</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="nf">get_table</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">table_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">    </span><span class="cm">/**&lt; Get the CRC hash table. */</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">CRC8</span><span class="w"> </span><span class="n">Instance</span><span class="p">;</span><span class="w"> </span><span class="cm">/**&lt; Singleton instance of CRC8 class. */</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">42</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">polynomial_</span><span class="p">;</span><span class="w"> </span><span class="cm">/** CRC polynomial **/</span>
<span class="linenos">43</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">check_</span><span class="p">;</span><span class="w">      </span><span class="cm">/**&lt; CRC check value. */</span>
<span class="linenos">44</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">table_</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"> </span><span class="cm">/**&lt; CRC hash table. */</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos">47</span><span class="cm">     * @brief Private constructor for CRC8 class.</span>
<span class="linenos">48</span><span class="cm">     */</span>
<span class="linenos">49</span><span class="w">    </span><span class="n">CRC8</span><span class="p">();</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos">52</span><span class="cm">     * @brief Initialize the CRC hash table.</span>
<span class="linenos">53</span><span class="cm">     */</span>
<span class="linenos">54</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_table</span><span class="p">();</span>
<span class="linenos">55</span><span class="p">};</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="cp">#endif </span><span class="c1">// CRC_HPP</span>
</pre></div>
</div>
</div>
<p>The constructor of <code class="docutils literal notranslate"><span class="pre">CRC8</span></code> class is private so no multiple instances will be created by <code class="docutils literal notranslate"><span class="pre">user</span></code> except one we created as static member. Such type of class is called <code class="docutils literal notranslate"><span class="pre">singletone</span></code> class.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">crc8.cpp</span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/**</span>
<span class="linenos"> 2</span><span class="cm"> * *********************************************************************************************</span>
<span class="linenos"> 3</span><span class="cm"> * @file crc8.cpp</span>
<span class="linenos"> 4</span><span class="cm"> * @brief Implementation file for the 8-bit SMBus CRC class</span>
<span class="linenos"> 5</span><span class="cm"> * @author Robotics Team, IOE Pulchowk Campus</span>
<span class="linenos"> 6</span><span class="cm"> * @date 2024</span>
<span class="linenos"> 7</span><span class="cm"> *</span>
<span class="linenos"> 8</span><span class="cm"> * For more information on CRC calculation in C, \</span>
<span class="linenos"> 9</span><span class="cm"> * see \link https://barrgroup.com/embedded-systems/how-to/crc-calculation-c-code \endlink.</span>
<span class="linenos">10</span><span class="cm"> ***********************************************************************************************</span>
<span class="linenos">11</span><span class="cm"> */</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">14</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="n">CRC8</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">Instance</span><span class="p">;</span>
<span class="linenos">17</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">polynomial_</span><span class="p">;</span>
<span class="linenos">18</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">check_</span><span class="p">;</span>
<span class="linenos">19</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">table_</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="n">CRC8</span><span class="o">::</span><span class="n">CRC8</span><span class="p">()</span>
<span class="linenos">22</span><span class="p">{</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">polynomial_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRC8_SMBUS_POLYNOMIAL</span><span class="p">;</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">initialize_table</span><span class="p">();</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;4&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;5&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;7&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;8&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;9&#39;</span><span class="p">};</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">check_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_hash</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="linenos">28</span><span class="p">}</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="kt">void</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">initialize_table</span><span class="p">()</span>
<span class="linenos">31</span><span class="p">{</span>
<span class="linenos">32</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">dividend</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bit</span><span class="p">;</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dividend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">dividend</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">dividend</span><span class="p">)</span>
<span class="linenos">37</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">38</span><span class="w">        </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dividend</span><span class="p">;</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">bit</span><span class="p">)</span>
<span class="linenos">41</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">42</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span>
<span class="linenos">43</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">44</span><span class="w">                </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">polynomial_</span><span class="p">;</span>
<span class="linenos">45</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">46</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">47</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">48</span><span class="w">                </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">50</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">51</span><span class="w">        </span><span class="n">table_</span><span class="p">[(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">dividend</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="linenos">52</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">53</span><span class="p">}</span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">get_hash</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="linenos">56</span><span class="p">{</span>
<span class="linenos">57</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">58</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">dividend</span><span class="p">;</span>
<span class="linenos">59</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">62</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">63</span><span class="w">        </span><span class="n">dividend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="linenos">64</span><span class="w">        </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table_</span><span class="p">[</span><span class="n">dividend</span><span class="p">];</span>
<span class="linenos">65</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">66</span>
<span class="linenos">67</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="linenos">68</span><span class="p">}</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="kt">void</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">print_table</span><span class="p">()</span>
<span class="linenos">71</span><span class="p">{</span>
<span class="linenos">72</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">73</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">74</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%02X, &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">table_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">75</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">76</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">77</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">78</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">79</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">80</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">81</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>To ensure the <code class="docutils literal notranslate"><span class="pre">CRC8</span></code> compatibility with other <code class="docutils literal notranslate"><span class="pre">CRC8</span></code>, the <code class="docutils literal notranslate"><span class="pre">loockup</span> <span class="pre">table</span></code> and <code class="docutils literal notranslate"><span class="pre">check</span></code> value are compared.  Now write the test code.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">crc8_test.cpp</span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos"> 5</span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">CRC8</span><span class="o">::</span><span class="n">print_table</span><span class="p">();</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;4&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;5&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;7&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;8&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;9&#39;</span><span class="p">};</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">setf</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">hex</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">basefield</span><span class="p">);</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;CRC-8 hash: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">CRC8</span><span class="o">::</span><span class="n">Instance</span><span class="p">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Compile and run this code.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>g++<span class="w"> </span>crc8.cpp<span class="w"> </span>crc8_test.cpp<span class="w"> </span>-o<span class="w"> </span>crc8_test
./crc8_test
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">Output</span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0x00, 0x07, 0x0E, 0x09, 0x1C, 0x1B, 0x12, 0x15,
0x38, 0x3F, 0x36, 0x31, 0x24, 0x23, 0x2A, 0x2D,
0x70, 0x77, 0x7E, 0x79, 0x6C, 0x6B, 0x62, 0x65,
0x48, 0x4F, 0x46, 0x41, 0x54, 0x53, 0x5A, 0x5D,
0xE0, 0xE7, 0xEE, 0xE9, 0xFC, 0xFB, 0xF2, 0xF5,
0xD8, 0xDF, 0xD6, 0xD1, 0xC4, 0xC3, 0xCA, 0xCD,
0x90, 0x97, 0x9E, 0x99, 0x8C, 0x8B, 0x82, 0x85,
0xA8, 0xAF, 0xA6, 0xA1, 0xB4, 0xB3, 0xBA, 0xBD,
0xC7, 0xC0, 0xC9, 0xCE, 0xDB, 0xDC, 0xD5, 0xD2,
0xFF, 0xF8, 0xF1, 0xF6, 0xE3, 0xE4, 0xED, 0xEA,
0xB7, 0xB0, 0xB9, 0xBE, 0xAB, 0xAC, 0xA5, 0xA2,
0x8F, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9D, 0x9A,
0x27, 0x20, 0x29, 0x2E, 0x3B, 0x3C, 0x35, 0x32,
0x1F, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0D, 0x0A,
0x57, 0x50, 0x59, 0x5E, 0x4B, 0x4C, 0x45, 0x42,
0x6F, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7D, 0x7A,
0x89, 0x8E, 0x87, 0x80, 0x95, 0x92, 0x9B, 0x9C,
0xB1, 0xB6, 0xBF, 0xB8, 0xAD, 0xAA, 0xA3, 0xA4,
0xF9, 0xFE, 0xF7, 0xF0, 0xE5, 0xE2, 0xEB, 0xEC,
0xC1, 0xC6, 0xCF, 0xC8, 0xDD, 0xDA, 0xD3, 0xD4,
0x69, 0x6E, 0x67, 0x60, 0x75, 0x72, 0x7B, 0x7C,
0x51, 0x56, 0x5F, 0x58, 0x4D, 0x4A, 0x43, 0x44,
0x19, 0x1E, 0x17, 0x10, 0x05, 0x02, 0x0B, 0x0C,
0x21, 0x26, 0x2F, 0x28, 0x3D, 0x3A, 0x33, 0x34,
0x4E, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5C, 0x5B,
0x76, 0x71, 0x78, 0x7F, 0x6A, 0x6D, 0x64, 0x63,
0x3E, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2C, 0x2B,
0x06, 0x01, 0x08, 0x0F, 0x1A, 0x1D, 0x14, 0x13,
0xAE, 0xA9, 0xA0, 0xA7, 0xB2, 0xB5, 0xBC, 0xBB,
0x96, 0x91, 0x98, 0x9F, 0x8A, 0x8D, 0x84, 0x83,
0xDE, 0xD9, 0xD0, 0xD7, 0xC2, 0xC5, 0xCC, 0xCB,
0xE6, 0xE1, 0xE8, 0xEF, 0xFA, 0xFD, 0xF4, 0xF3,

CRC-8 hash: f4
</pre></div>
</div>
</div>
</section>
<section id="sending-packets-through-uart-using-arduino">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">5. Sending Packets through UART using Arduino</a><a class="headerlink" href="#sending-packets-through-uart-using-arduino" title="Link to this heading"></a></h2>
<p>Let’s suppose you want to send packets that contains joystick data twist(vx, vy, w). To do so, select one start byte <code class="docutils literal notranslate"><span class="pre">0xA5</span></code>, then three bytes for vx, vy and w, and one byte for CRC.</p>
<ul>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">sketch</span></code> in <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">IDE</span></code>. Save it as <code class="docutils literal notranslate"><span class="pre">sending_packets</span></code>.</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">terminal</span></code> in the <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">IDE</span></code> using <code class="docutils literal notranslate"><span class="pre">ctrl</span></code> + <code class="docutils literal notranslate"><span class="pre">`</span></code>. Create files <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code>.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span><span class="w"> </span><span class="n">crc8</span><span class="p">.</span><span class="n">hpp</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">crc8</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
</li>
<li><p>Copy the contents of <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> from above <a class="reference external" href="#implementing-smbus-crc-8">section 4</a>.</p></li>
<li><p>Now copy and paste these contensts in <code class="docutils literal notranslate"><span class="pre">sending_packets.ino</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">sending_packets.ino</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span><span class="w"> </span><span class="nc">Twist</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="p">};</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">START_BYTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xA5</span><span class="p">;</span>
<span class="linenos">10</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">LED_PIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="n">Twist</span><span class="w"> </span><span class="n">twist</span><span class="p">;</span>
<span class="linenos">13</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sending_packet</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">14</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_sent_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">()</span>
<span class="linenos">18</span><span class="p">{</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">));</span>
<span class="linenos">23</span><span class="w">  </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">24</span><span class="p">}</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">29</span><span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="linenos">30</span><span class="p">}</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">33</span><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">34</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_sent_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">35</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">  </span><span class="n">twist</span><span class="p">.</span><span class="n">vx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="linenos">38</span><span class="w">  </span><span class="n">twist</span><span class="p">.</span><span class="n">vy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="linenos">39</span><span class="w">  </span><span class="n">twist</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">  </span><span class="n">sending_packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">START_BYTE</span><span class="p">;</span>
<span class="linenos">42</span><span class="w">  </span><span class="n">memcpy</span><span class="p">(</span><span class="n">sending_packet</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">twist</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">twist</span><span class="p">));</span>
<span class="linenos">43</span><span class="w">  </span><span class="n">sending_packet</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sending_packet</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">get_hash</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">twist</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">twist</span><span class="p">));</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sending_packet</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sending_packet</span><span class="p">));</span>
<span class="linenos">46</span><span class="w">  </span><span class="n">blink_led</span><span class="p">();</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="w">  </span><span class="n">last_sent_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="linenos">49</span><span class="p">}</span>
</pre></div>
</div>
</div>
</li>
<li><p>Compile and upload the code to your <code class="docutils literal notranslate"><span class="pre">Arduino</span></code>.</p></li>
</ul>
</section>
<section id="receiving-packets-through-uart-using-arduino">
<h2><a class="toc-backref" href="#id25" role="doc-backlink">6. Receiving Packets through UART using Arduino</a><a class="headerlink" href="#receiving-packets-through-uart-using-arduino" title="Link to this heading"></a></h2>
<p>Now you have to receive packets and parse them. The format used for sending packets should be same while parsing.</p>
<ul>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">sketch</span></code> in <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">IDE</span></code>. Save it as <code class="docutils literal notranslate"><span class="pre">receiving_packets</span></code>.</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">terminal</span></code> in the <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">IDE</span></code> using <code class="docutils literal notranslate"><span class="pre">ctrl</span></code> + <code class="docutils literal notranslate"><span class="pre">`</span></code>. Create files <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code>.</p>
<blockquote>
<div><div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span><span class="w"> </span><span class="n">crc8</span><span class="p">.</span><span class="n">hpp</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">crc8</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Copy the contents of <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> from above <a class="reference external" href="#implementing-smbus-crc-8">section 4</a>.</p></li>
<li><p>Now copy and paste these contensts in <code class="docutils literal notranslate"><span class="pre">receiving_packets.ino</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">receiving_packets.ino</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">struct</span><span class="w"> </span><span class="nc">Twist</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="p">};</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">START_BYTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xA5</span><span class="p">;</span>
<span class="linenos">10</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">LED_PIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="n">Twist</span><span class="w"> </span><span class="n">twist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="linenos">13</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">receiving_packet</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_received_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">16</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">17</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_printed_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="kt">char</span><span class="w"> </span><span class="n">print_buffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">();</span>
<span class="linenos">24</span><span class="kt">void</span><span class="w"> </span><span class="nf">print_twist</span><span class="p">();</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">()</span>
<span class="linenos">27</span><span class="p">{</span>
<span class="linenos">28</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">));</span>
<span class="linenos">32</span><span class="w">  </span><span class="n">last_blinked_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">33</span><span class="p">}</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="kt">void</span><span class="w"> </span><span class="nf">print_twist</span><span class="p">()</span>
<span class="linenos">36</span><span class="p">{</span>
<span class="linenos">37</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_printed_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos">38</span><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;vx: &quot;</span><span class="p">);</span>
<span class="linenos">41</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">twist</span><span class="p">.</span><span class="n">vx</span><span class="p">);</span>
<span class="linenos">42</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s"> vy: &quot;</span><span class="p">);</span>
<span class="linenos">43</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">twist</span><span class="p">.</span><span class="n">vy</span><span class="p">);</span>
<span class="linenos">44</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s"> w&quot;</span><span class="p">);</span>
<span class="linenos">45</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">twist</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">  </span><span class="n">last_printed_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">48</span><span class="p">}</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos">52</span><span class="w">  </span><span class="n">Serial1</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="linenos">53</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="linenos">55</span><span class="p">}</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">58</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_waiting_for_start_byte</span><span class="p">)</span>
<span class="linenos">59</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">60</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Serial1</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">61</span><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">      </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">received_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serial1</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
<span class="linenos">64</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">received_start_byte</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">START_BYTE</span><span class="p">)</span>
<span class="linenos">65</span><span class="w">      </span><span class="p">{</span>
<span class="linenos">66</span><span class="w">        </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">67</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">68</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">69</span><span class="w">      </span><span class="p">{</span>
<span class="linenos">70</span><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Start Byte Error!&quot;</span><span class="p">);</span>
<span class="linenos">71</span><span class="w">        </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos">72</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">73</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">74</span><span class="w">  </span><span class="k">else</span>
<span class="linenos">75</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">76</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Serial1</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">receiving_packet</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span>
<span class="linenos">77</span><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">78</span>
<span class="linenos">79</span><span class="w">    </span><span class="n">Twist</span><span class="w"> </span><span class="n">received_twist</span><span class="p">;</span>
<span class="linenos">80</span><span class="w">    </span><span class="n">Serial1</span><span class="p">.</span><span class="n">readBytes</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">received_twist</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">received_twist</span><span class="p">));</span>
<span class="linenos">81</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">received_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serial1</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
<span class="linenos">82</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">calculated_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">get_hash</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">received_twist</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">twist</span><span class="p">));</span>
<span class="linenos">83</span>
<span class="linenos">84</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">received_hash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">calculated_hash</span><span class="p">)</span>
<span class="linenos">85</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">86</span><span class="w">      </span><span class="n">twist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">received_twist</span><span class="p">;</span>
<span class="linenos">87</span><span class="w">      </span><span class="n">print_twist</span><span class="p">();</span>
<span class="linenos">88</span><span class="w">      </span><span class="n">last_received_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">89</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">90</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">91</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">92</span><span class="w">      </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;CRC Error&quot;</span><span class="p">);</span>
<span class="linenos">93</span><span class="w">      </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos">94</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">95</span>
<span class="linenos">96</span><span class="w">    </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">97</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">98</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>This receiving code is written for <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">Mega</span></code>. You may want to modify it for other boards. It is better to use microcontroller having atleast two UARTs like <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">Mega</span></code> has three UARTs.</p>
</li>
<li><p>Compile and upload the code to your <code class="docutils literal notranslate"><span class="pre">Arduino</span></code>.</p></li>
<li><p>Connect the <code class="docutils literal notranslate"><span class="pre">TX</span> <span class="pre">pin</span></code> of <code class="docutils literal notranslate"><span class="pre">Sender</span></code> and <code class="docutils literal notranslate"><span class="pre">RX</span> <span class="pre">pin</span></code> of <code class="docutils literal notranslate"><span class="pre">Receiver</span></code>. Common <code class="docutils literal notranslate"><span class="pre">GND</span></code> of both.</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">Serial</span> <span class="pre">Monitor</span></code> in the <code class="docutils literal notranslate"><span class="pre">Arduino</span> <span class="pre">IDE</span></code>. Set boudrate to <code class="docutils literal notranslate"><span class="pre">115200</span></code> or that in your code. You will see the parsed data.</p></li>
</ul>
<a class="padded-image reference internal image-reference" href="../_images/receiving_in_arduino.png"><img alt="receiving_in_arduino.png" class="padded-image align-center" src="../_images/receiving_in_arduino.png" style="width: 100%;" />
</a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is better to include start byte in the CRC calculation. So if data are misaligned, the CRC will not match. The receiver will discard the packet and wait for next packet.</p>
<p>For example, CRC of one byte <code class="docutils literal notranslate"><span class="pre">0x12</span></code> is same as CRC of two bytes <code class="docutils literal notranslate"><span class="pre">0x00</span></code> and <code class="docutils literal notranslate"><span class="pre">0x12</span></code> because of adding <code class="docutils literal notranslate"><span class="pre">0</span></code> at the left of a number does not change its value i.e. <code class="docutils literal notranslate"><span class="pre">0x12</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">0x0012</span></code>. But if you include start byte, the CRC will be different.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The more standard way to check error at receiver side is to calculate CRC of data including CRC sent from transmitter. If the accumulated CRC is <code class="docutils literal notranslate"><span class="pre">0</span></code>, then the data is correct. If not, then there is error in the data.</p>
</div>
</section>
<section id="sending-packets-through-uart-using-stm32">
<h2><a class="toc-backref" href="#id26" role="doc-backlink">7. Sending Packets through UART using STM32</a><a class="headerlink" href="#sending-packets-through-uart-using-stm32" title="Link to this heading"></a></h2>
<ul>
<li><p>Create and generate new STM32 project using <strong>STM32CubeMX</strong>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Name</span></code>: <code class="docutils literal notranslate"><span class="pre">sending_packets</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Microcontroller</span></code>: <code class="docutils literal notranslate"><span class="pre">STM32F103C8</span></code> or any other STM32 microcontroller</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Toolchain/IDE</span></code>: <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> or <code class="docutils literal notranslate"><span class="pre">CMake</span></code></p></li>
</ul>
</li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">Connectivity</span></code> and select any <code class="docutils literal notranslate"><span class="pre">USART</span></code> with mode <code class="docutils literal notranslate"><span class="pre">Asynchronous</span></code>. Under <code class="docutils literal notranslate"><span class="pre">DMA</span> <span class="pre">settings</span></code>, enable <code class="docutils literal notranslate"><span class="pre">DMA</span></code> for <code class="docutils literal notranslate"><span class="pre">Transmit</span></code>. Follow the <a class="reference external" href="../stm32_basics_tutorial.html">UART with DMA tutorial</a> to setup more details.</p></li>
<li><p>Also assign an <code class="docutils literal notranslate"><span class="pre">LED</span></code> pin for <code class="docutils literal notranslate"><span class="pre">GPIO_Output.</span></code></p>
<a class="padded-image reference internal image-reference" href="../_images/sending_packets_cubemx.png"><img alt="sending_packets_cubemx.png" class="padded-image align-center" src="../_images/sending_packets_cubemx.png" style="width: 100%;" />
</a>
</li>
<li><p>Follow <a class="reference external" href="cpp_setup_in_stm32.html">C++ setup tutorial</a> and setup up to compile <code class="docutils literal notranslate"><span class="pre">C++</span></code> souce codes. In the <a class="reference external" href="cpp_setup_in_stm32.html">C++ setup tutorial</a>, you have already created <code class="docutils literal notranslate"><span class="pre">app.h</span></code> and <code class="docutils literal notranslate"><span class="pre">app.cpp</span></code>, and blinked the LED. Reach to that point.</p></li>
<li><p>Create a new file <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> in <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Inc</span></code> and <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Src</span></code> respectively. Copy the contents of <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> from above <a class="reference external" href="#implementing-smbus-crc-8">section 4</a>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">app.h</span></code> and <code class="docutils literal notranslate"><span class="pre">app.cppp</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">app.h</span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#ifndef __APP_H</span>
<span class="linenos"> 2</span><span class="cp">#define __APP_H</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#ifdef __cplusplus</span>
<span class="linenos"> 5</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="cp">#endif</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">();</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">();</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">();</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#ifdef __cplusplus</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span><span class="cp">#endif</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="cp">#endif </span><span class="c1">// __APP_H</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">app.cpp</span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;stm32f1xx_hal.h&quot;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usart.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;app.h&quot;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#define START_BYTE 0xA5</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">struct</span><span class="w"> </span><span class="nc">Twist</span>
<span class="linenos">11</span><span class="p">{</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span>
<span class="linenos">13</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">};</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="n">Twist</span><span class="w"> </span><span class="n">twist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="linenos">18</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">transmitting_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_tranmsit_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">21</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span>
<span class="linenos">24</span><span class="p">{</span>
<span class="linenos">25</span><span class="p">}</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span>
<span class="linenos">28</span><span class="p">{</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_tranmsit_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">30</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="n">twist</span><span class="p">.</span><span class="n">vx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="linenos">33</span><span class="w">    </span><span class="n">twist</span><span class="p">.</span><span class="n">vy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">    </span><span class="n">twist</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="n">transmitting_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">START_BYTE</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">transmitting_bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">twist</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">twist</span><span class="p">));</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">transmitting_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">transmitting_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">get_hash</span><span class="p">((</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">twist</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">twist</span><span class="p">));</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="n">HAL_UART_Transmit_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">transmitting_bytes</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">transmitting_bytes</span><span class="p">));</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="n">last_tranmsit_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos">43</span><span class="p">}</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">()</span>
<span class="linenos">46</span><span class="p">{</span>
<span class="linenos">47</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos">48</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_13</span><span class="p">);</span>
<span class="linenos">50</span><span class="w">        </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos">51</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">52</span><span class="p">}</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="c1">// Make sure you have enabled the UART interrupt in the CubeMX</span>
<span class="linenos">55</span><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_TxCpltCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">huart</span><span class="p">)</span>
<span class="linenos">56</span><span class="p">{</span>
<span class="linenos">57</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">huart1</span><span class="p">.</span><span class="n">Instance</span><span class="p">)</span>
<span class="linenos">58</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">59</span><span class="w">        </span><span class="n">blink_led</span><span class="p">();</span>
<span class="linenos">60</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">61</span><span class="p">}</span>
</pre></div>
</div>
</div>
</li>
<li><p>Add souces to <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> or <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
<li><p>Build and upload the code to your <code class="docutils literal notranslate"><span class="pre">STM32</span></code>.</p></li>
</ul>
</section>
<section id="receiving-packets-through-uart-using-stm32">
<h2><a class="toc-backref" href="#id27" role="doc-backlink">8. Receiving Packets through UART using STM32</a><a class="headerlink" href="#receiving-packets-through-uart-using-stm32" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Create and generate new STM32 project using <strong>STM32CubeMX</strong>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Name</span></code>: <code class="docutils literal notranslate"><span class="pre">receiving_packets</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Microcontroller</span></code>: <code class="docutils literal notranslate"><span class="pre">STM32F103C8</span></code> or any other STM32 microcontroller</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Toolchain/IDE</span></code>: <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> or <code class="docutils literal notranslate"><span class="pre">CMake</span></code></p></li>
</ul>
</li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">Connectivity</span></code> and select any <code class="docutils literal notranslate"><span class="pre">USART</span></code> with mode <code class="docutils literal notranslate"><span class="pre">Asynchronous</span></code>. Under <code class="docutils literal notranslate"><span class="pre">DMA</span> <span class="pre">settings</span></code>, enable <code class="docutils literal notranslate"><span class="pre">DMA</span></code> for <code class="docutils literal notranslate"><span class="pre">Receive</span></code>. Follow the <a class="reference external" href="../stm32_basics_tutorial.html">UART with DMA tutorial</a> to setup more details.</p></li>
<li><p>Assign assign an <code class="docutils literal notranslate"><span class="pre">LED</span></code> pin for <code class="docutils literal notranslate"><span class="pre">GPIO_Output.</span></code> If you want to print over <code class="docutils literal notranslate"><span class="pre">USB</span></code>, enable <code class="docutils literal notranslate"><span class="pre">USB</span></code> and <code class="docutils literal notranslate"><span class="pre">Virtual</span> <span class="pre">COM</span> <span class="pre">Port</span></code>. See <a class="reference external" href="../stm32_basics_tutorial/usb/usb_printf.html">USB tutorial</a>.</p></li>
</ul>
<a class="padded-image reference internal image-reference" href="../_images/receiving_packets_cubemx.png"><img alt="receiving_packets_cubemx.png" class="padded-image align-center" src="../_images/receiving_packets_cubemx.png" style="width: 100%;" />
</a>
<ul>
<li><p>Follow <a class="reference external" href="cpp_setup_in_stm32.html">C++ setup tutorial</a> and setup up to compile <code class="docutils literal notranslate"><span class="pre">C++</span></code> souce codes. In the <a class="reference external" href="cpp_setup_in_stm32.html">C++ setup tutorial</a>, you have already created <code class="docutils literal notranslate"><span class="pre">app.h</span></code> and <code class="docutils literal notranslate"><span class="pre">app.cpp</span></code>, and blinked the LED. Reach to that point.</p></li>
<li><p>Create a new file <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> in <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Inc</span></code> and <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Src</span></code> respectively. Copy the contents of <code class="docutils literal notranslate"><span class="pre">crc8.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">crc8.cpp</span></code> from above <a class="reference external" href="#implementing-smbus-crc-8">section 4</a>.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">printf_config.c</span></code> in <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Src</span></code>. Copy the contents below.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">printf_config.c</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;stm32f1xx_hal.h&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="cp">#define USE_USB_CDC</span>
<span class="linenos"> 4</span><span class="cp">#ifdef USE_USB_CDC</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usbd_cdc_if.h&quot;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="nf">_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">CDC_Transmit_FS</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="linenos">12</span><span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#else</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">int</span><span class="w"> </span><span class="nf">_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="linenos">17</span><span class="p">{</span>
<span class="linenos">18</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">19</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">20</span><span class="w">        </span><span class="n">ITM_SendChar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">22</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="linenos">23</span><span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="cp">#endif</span>
</pre></div>
</div>
</div>
<p>Change definition to use <code class="docutils literal notranslate"><span class="pre">ITM</span></code>.</p>
</li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">app.h</span></code> and <code class="docutils literal notranslate"><span class="pre">app.cpp</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">app.h</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#ifndef __APP_H</span>
<span class="linenos"> 2</span><span class="cp">#define __APP_H</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#ifdef __cplusplus</span>
<span class="linenos"> 5</span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="cp">#endif</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">();</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">();</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">();</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">void</span><span class="w"> </span><span class="nf">print_twist</span><span class="p">();</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="cp">#ifdef __cplusplus</span>
<span class="linenos">17</span><span class="p">}</span>
<span class="linenos">18</span><span class="cp">#endif</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="cp">#endif </span><span class="c1">// __APP_H</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">app.cpp</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory.h&gt;</span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;stm32f1xx_hal.h&quot;</span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usart.h&quot;</span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;crc8.hpp&quot;</span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;app.h&quot;</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="cp">#define START_BYTE 0xA5</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="k">struct</span><span class="w"> </span><span class="nc">Twist</span>
<span class="linenos"> 12</span><span class="p">{</span>
<span class="linenos"> 13</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span>
<span class="linenos"> 14</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span>
<span class="linenos"> 15</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 16</span><span class="p">};</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="n">Twist</span><span class="w"> </span><span class="n">twist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">};</span>
<span class="linenos"> 19</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">receiving_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 20</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 21</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">rx_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 22</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">used_rx_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_receive_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 25</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 26</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_print_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span>
<span class="linenos"> 30</span><span class="p">{</span>
<span class="linenos"> 31</span><span class="w">    </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">receiving_bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 32</span><span class="w">    </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 33</span><span class="p">}</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span>
<span class="linenos"> 36</span><span class="p">{</span>
<span class="linenos"> 37</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_tranmsit_tick</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos"> 38</span><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_seq</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">used_rx_seq</span><span class="p">)</span>
<span class="linenos"> 41</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 42</span><span class="w">        </span><span class="n">print_twist</span><span class="p">();</span>
<span class="linenos"> 43</span><span class="w">        </span><span class="n">used_rx_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx_seq</span><span class="p">;</span>
<span class="linenos"> 44</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart1</span><span class="p">.</span><span class="n">gstate</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_UART_STATE_BUSY_TX</span><span class="p">)</span>
<span class="linenos"> 47</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 48</span><span class="w">        </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">receiving_bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 49</span><span class="w">        </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 50</span><span class="w">        </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="n">last_tranmsit_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos"> 54</span><span class="p">}</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="kt">void</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">()</span>
<span class="linenos"> 57</span><span class="p">{</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 60</span><span class="w">        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_13</span><span class="p">);</span>
<span class="linenos"> 61</span><span class="w">        </span><span class="n">last_led_blink_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 63</span><span class="p">}</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="kt">void</span><span class="w"> </span><span class="nf">print_twist</span><span class="p">()</span>
<span class="linenos"> 66</span><span class="p">{</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_print_tick</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 69</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;vx: %f, vy: %f, w: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">twist</span><span class="p">.</span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="n">twist</span><span class="p">.</span><span class="n">vy</span><span class="p">,</span><span class="w"> </span><span class="n">twist</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
<span class="linenos"> 70</span><span class="w">        </span><span class="n">last_print_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 72</span><span class="p">}</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_RxCpltCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">huart</span><span class="p">)</span>
<span class="linenos"> 75</span><span class="p">{</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="n">__HAL_UART_FLUSH_DRREGISTER</span><span class="p">(</span><span class="n">huart</span><span class="p">);</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">huart1</span><span class="p">.</span><span class="n">Instance</span><span class="p">)</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_waiting_for_start_byte</span><span class="p">)</span>
<span class="linenos"> 81</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 82</span><span class="w">            </span><span class="c1">// verify start byte</span>
<span class="linenos"> 83</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiving_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">START_BYTE</span><span class="p">)</span>
<span class="linenos"> 84</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 85</span><span class="w">                </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">receiving_bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 86</span><span class="w">                </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 88</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 89</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 90</span><span class="w">                </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">receiving_bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 91</span><span class="w">                </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos"> 92</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="k">else</span>
<span class="linenos"> 95</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 96</span><span class="w">            </span><span class="c1">// verify hash</span>
<span class="linenos"> 97</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receiving_bytes</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">receiving_bytes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CRC8</span><span class="o">::</span><span class="n">get_hash</span><span class="p">(</span><span class="n">receiving_bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">)))</span>
<span class="linenos"> 98</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 99</span><span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twist</span><span class="p">,</span><span class="w"> </span><span class="n">receiving_bytes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Twist</span><span class="p">));</span>
<span class="linenos">100</span><span class="w">                </span><span class="n">rx_seq</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">101</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">102</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">103</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">104</span><span class="w">                </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos">105</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">            </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">108</span><span class="w">            </span><span class="n">last_receive_tick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="linenos">109</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">110</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">111</span><span class="p">}</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_ErrorCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">huart</span><span class="p">)</span>
<span class="linenos">114</span><span class="p">{</span>
<span class="linenos">115</span><span class="w">    </span><span class="n">__HAL_UART_FLUSH_DRREGISTER</span><span class="p">(</span><span class="n">huart</span><span class="p">);</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">huart1</span><span class="p">.</span><span class="n">Instance</span><span class="p">)</span>
<span class="linenos">118</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">119</span><span class="w">        </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">receiving_bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">120</span><span class="w">        </span><span class="n">is_waiting_for_start_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">121</span><span class="w">        </span><span class="n">blink_led</span><span class="p">();</span><span class="w"> </span><span class="c1">// blink led to show error</span>
<span class="linenos">122</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">123</span><span class="p">}</span>
</pre></div>
</div>
</div>
</li>
<li><p>Add souces to <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> or <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>.</p></li>
<li><p>Build and upload the code to your <code class="docutils literal notranslate"><span class="pre">STM32</span></code>.</p></li>
</ul>
<p>Connect the <code class="docutils literal notranslate"><span class="pre">TX</span> <span class="pre">pin</span></code> of <code class="docutils literal notranslate"><span class="pre">Sender</span></code> and <code class="docutils literal notranslate"><span class="pre">RX</span> <span class="pre">pin</span></code> of <code class="docutils literal notranslate"><span class="pre">Receiver</span></code>. Common <code class="docutils literal notranslate"><span class="pre">GND</span></code> of both. Observe the data on <code class="docutils literal notranslate"><span class="pre">USB</span></code> or <code class="docutils literal notranslate"><span class="pre">ITM</span></code> using <code class="docutils literal notranslate"><span class="pre">Serial</span> <span class="pre">Monitor</span> <span class="pre">or</span> <span class="pre">Terminal</span></code> or <code class="docutils literal notranslate"><span class="pre">STM32CubeProgrammer</span> <span class="pre">SWV</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="crc.html" class="btn btn-neutral float-left" title="Cyclic Redundancy Check (CRC)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="arm_math.html" class="btn btn-neutral float-right" title="ARM Math" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024 - 2025, Robotics Club, Pulchowk Campus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>